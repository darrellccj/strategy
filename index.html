<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Investment Simulator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Times New Roman', Times, Georgia, serif;
      background: #faf8f5;
      color: #3d3929;
      min-height: 100vh;
      padding: 24px 16px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: #5c5340;
      margin-bottom: 32px;
      text-align: center;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(92, 83, 64, 0.08);
    }

    .input-group {
      margin-bottom: 24px;
    }

    .input-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: #6b5f4d;
      margin-bottom: 10px;
    }

    /* Ticker Search */
    .ticker-search-wrapper {
      position: relative;
    }

    .ticker-search {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e0d5;
      border-radius: 10px;
      font-size: 1.1rem;
      color: #3d3929;
      background: #faf8f5;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    .ticker-search:focus {
      outline: none;
      border-color: #a08c6d;
    }

    .ticker-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #ffffff;
      border: 2px solid #e5e0d5;
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 240px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(92, 83, 64, 0.12);
    }

    .ticker-dropdown.open {
      display: block;
    }

    .ticker-option {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.15s ease;
    }

    .ticker-option:hover {
      background: #f0ebe2;
    }

    .ticker-option .ticker-symbol {
      font-weight: 600;
      color: #5c5340;
      font-size: 1rem;
    }

    .ticker-option .ticker-name {
      font-size: 0.85rem;
      color: #9a8d79;
    }

    .ticker-search.has-focus {
      border-radius: 10px 10px 0 0;
    }

    /* Contribution Style Toggle */
    .toggle-container {
      display: flex;
      background: #f0ebe2;
      border-radius: 10px;
      padding: 4px;
    }

    .toggle-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      color: #6b5f4d;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .toggle-btn.active {
      background: #ffffff;
      color: #5c5340;
      box-shadow: 0 2px 4px rgba(92, 83, 64, 0.1);
    }

    /* Amount Input */
    .amount-input-wrapper {
      position: relative;
    }

    .currency-symbol {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #a08c6d;
      font-size: 1.1rem;
      font-weight: 500;
    }

    .amount-input {
      width: 100%;
      padding: 14px 16px 14px 36px;
      border: 2px solid #e5e0d5;
      border-radius: 10px;
      font-size: 1.1rem;
      color: #3d3929;
      background: #faf8f5;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    .amount-input:focus {
      outline: none;
      border-color: #a08c6d;
    }

    .amount-hint {
      font-size: 0.8rem;
      color: #9a8d79;
      margin-top: 6px;
    }

    /* Time Slider */
    .slider-container {
      padding: 0 4px;
    }

    .time-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #e5e0d5;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    .time-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #a08c6d;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(92, 83, 64, 0.3);
      transition: transform 0.2s ease;
    }

    .time-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .time-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #a08c6d;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(92, 83, 64, 0.3);
    }

    .slider-value {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      color: #5c5340;
      margin-top: 12px;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #9a8d79;
      margin-top: 8px;
    }

    /* Results Section */
    .results-card {
      background: linear-gradient(135deg, #f5f0e8 0%, #ebe5d9 100%);
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .result-item {
      background: #ffffff;
      padding: 16px;
      border-radius: 12px;
    }

    .result-item.full-width {
      grid-column: 1 / -1;
    }

    .result-label {
      font-size: 0.8rem;
      color: #9a8d79;
      margin-bottom: 6px;
    }

    .result-value {
      font-size: 1.4rem;
      font-weight: 600;
      color: #5c5340;
    }

    .result-value.positive {
      color: #5a7a5a;
    }

    .result-value.negative {
      color: #8b5a5a;
    }

    .result-subtext {
      font-size: 0.8rem;
      color: #9a8d79;
      margin-top: 4px;
    }

    /* Chart */
    .chart-container {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
    }

    .chart-title {
      font-size: 0.85rem;
      color: #6b5f4d;
      margin-bottom: 12px;
      font-weight: 500;
    }

    canvas {
      width: 100%;
      height: 200px;
    }

    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 12px;
      font-size: 0.8rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-dot.typical { background: #a08c6d; }

    /* Loading state */
    .loading {
      opacity: 0.5;
      pointer-events: none;
    }

    .stock-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #f0ebe2;
      border-radius: 10px;
      margin-top: 10px;
    }

    .stock-price {
      font-size: 1.2rem;
      font-weight: 600;
      color: #5c5340;
    }

    .stock-change {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .stock-change.positive { color: #5a7a5a; }
    .stock-change.negative { color: #8b5a5a; }

    .data-source {
      font-size: 0.7rem;
      color: #9a8d79;
      text-align: center;
      margin-top: 16px;
    }

    .error-message {
      background: #f8e8e8;
      color: #8b5a5a;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-top: 10px;
    }

    /* Small mobile adjustments */
    @media (max-width: 400px) {
      h1 {
        font-size: 1.5rem;
      }

      .results-grid {
        grid-template-columns: 1fr;
      }

      .result-item.full-width {
        grid-column: 1;
      }
    }

    /* Desktop layout */
    @media (min-width: 768px) {
      body {
        padding: 40px 32px;
      }

      .container {
        max-width: 1200px;
      }

      h1 {
        font-size: 2rem;
        margin-bottom: 40px;
      }

      .main-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        align-items: start;
      }

      .card {
        padding: 32px;
        margin-bottom: 0;
      }

      .results-card {
        position: sticky;
        top: 40px;
      }

      .input-group {
        margin-bottom: 28px;
      }

      label {
        font-size: 0.95rem;
      }

      .toggle-btn {
        padding: 14px 20px;
        font-size: 1rem;
      }

      .amount-input {
        padding: 16px 16px 16px 40px;
        font-size: 1.2rem;
      }

      .currency-symbol {
        font-size: 1.2rem;
        left: 18px;
      }

      .slider-value {
        font-size: 1.75rem;
      }

      .result-value {
        font-size: 1.6rem;
      }

      .chart-container {
        padding: 20px;
      }

      canvas {
        height: 240px;
      }
    }

    /* Large desktop */
    @media (min-width: 1024px) {
      .main-layout {
        gap: 32px;
      }

      .card {
        padding: 36px;
        border-radius: 20px;
      }

      .result-item {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Investment Simulator</h1>

    <div class="main-layout">
    <div class="card">
      <div class="input-group">
        <label>Search for a Stock</label>
        <div class="ticker-search-wrapper">
          <input type="text" class="ticker-search" id="ticker-search" placeholder="Type to search (e.g. AAPL, BTC)" autocomplete="off">
          <div class="ticker-dropdown" id="ticker-dropdown"></div>
        </div>
        <div class="stock-info" id="stock-info">
          <span class="stock-price" id="stock-price">Loading...</span>
          <span class="stock-change" id="stock-change"></span>
        </div>
      </div>

      <div class="input-group">
        <label>Contribution Style</label>
        <div class="toggle-container">
          <button class="toggle-btn active" data-style="dca">Monthly</button>
          <button class="toggle-btn" data-style="lump">Lump Sum</button>
        </div>
      </div>

      <div class="input-group">
        <label id="amount-label">Monthly Amount</label>
        <div class="amount-input-wrapper">
          <span class="currency-symbol">$</span>
          <input type="text" class="amount-input" id="amount" value="500" inputmode="numeric">
        </div>
        <div class="amount-hint" id="amount-hint">Amount you'll invest each month</div>
      </div>

      <div class="input-group">
        <label>If you started investing...</label>
        <div class="slider-container">
          <input type="range" class="time-slider" id="years" min="1" max="10" value="5">
          <div class="slider-value"><span id="years-display">5</span> years ago</div>
          <div class="slider-labels">
            <span>1 year ago</span>
            <span>10 years ago</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card results-card">
      <div class="results-grid">
        <div class="result-item">
          <div class="result-label">Total Contributed</div>
          <div class="result-value" id="total-contributed">$120,000</div>
        </div>

        <div class="result-item">
          <div class="result-label">Max Drawdown</div>
          <div class="result-value negative" id="max-drawdown">-0%</div>
        </div>

        <div class="result-item full-width">
          <div class="result-label">Value Today</div>
          <div class="result-value" id="final-value">$270,000</div>
          <div class="result-subtext" id="profit-text">Profit: $150,000 <span id="gain-loss"></span></div>
        </div>

        <div class="result-item full-width">
          <div class="result-label">Shares Owned</div>
          <div class="result-value" id="shares-owned">0</div>
          <div class="result-subtext" id="avg-cost-text">Avg cost: $0.00/share</div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">Historical Portfolio Value</div>
        <canvas id="chart"></canvas>
        <div class="chart-legend">
          <div class="legend-item">
            <div class="legend-dot typical"></div>
            <span>Portfolio Value</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #d4cfc4;"></div>
            <span>Total Invested</span>
          </div>
        </div>
        <div class="data-source">Data from Yahoo Finance. Past performance doesn't guarantee future results.</div>
      </div>
    </div>
    </div>
  </div>

  <script>
    // Available tickers
    const TICKERS = [
      { symbol: 'AAPL', yahoo: 'AAPL', name: 'Apple' },
      { symbol: 'MSFT', yahoo: 'MSFT', name: 'Microsoft' },
      { symbol: 'GOOGL', yahoo: 'GOOGL', name: 'Alphabet (Google)' },
      { symbol: 'AMZN', yahoo: 'AMZN', name: 'Amazon' },
      { symbol: 'META', yahoo: 'META', name: 'Meta Platforms' },
      { symbol: 'NVDA', yahoo: 'NVDA', name: 'Nvidia' },
      { symbol: 'TSLA', yahoo: 'TSLA', name: 'Tesla' },
      { symbol: 'GLD', yahoo: 'GLD', name: 'SPDR Gold Trust' },
      { symbol: 'SLV', yahoo: 'SLV', name: 'iShares Silver Trust' },
      { symbol: 'VOO', yahoo: 'VOO', name: 'Vanguard S&P 500 ETF' },
      { symbol: 'SPY', yahoo: 'SPY', name: 'SPDR S&P 500 ETF' },
      { symbol: 'BTC', yahoo: 'BTC-USD', name: 'Bitcoin' },
      { symbol: 'ETH', yahoo: 'ETH-USD', name: 'Ethereum' },
    ];

    // State
    let state = {
      ticker: 'VOO',
      yahooTicker: 'VOO',
      style: 'dca',
      amount: 500,
      years: 5,
      tickerData: null
    };

    // Cache for ticker data
    const dataCache = {};

    // DOM Elements
    const tickerSearch = document.getElementById('ticker-search');
    const tickerDropdown = document.getElementById('ticker-dropdown');
    const styleBtns = document.querySelectorAll('.toggle-btn');
    const amountInput = document.getElementById('amount');
    const amountLabel = document.getElementById('amount-label');
    const amountHint = document.getElementById('amount-hint');
    const yearsSlider = document.getElementById('years');
    const yearsDisplay = document.getElementById('years-display');
    const resultsCard = document.querySelector('.results-card');
    const stockPriceEl = document.getElementById('stock-price');
    const stockChangeEl = document.getElementById('stock-change');

    // Format currency
    function formatCurrency(value) {
      if (value >= 1000000) {
        return '$' + (value / 1000000).toFixed(2) + 'M';
      }
      return '$' + Math.round(value).toLocaleString();
    }

    // Format percentage
    function formatPercent(value) {
      const sign = value >= 0 ? '+' : '';
      return sign + value.toFixed(1) + '%';
    }

    // CORS proxies to try in order
    const CORS_PROXIES = [
      (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    ];

    // Fetch with CORS proxy fallback
    async function fetchWithProxy(url) {
      for (const proxyFn of CORS_PROXIES) {
        try {
          const proxyUrl = proxyFn(url);
          const response = await fetch(proxyUrl);
          if (response.ok) {
            return await response.json();
          }
        } catch (e) {
          continue;
        }
      }
      throw new Error('All proxies failed');
    }

    // Fetch stock data from Yahoo Finance
    async function fetchStockData(yahooTicker) {
      // Check cache first
      if (dataCache[yahooTicker]) {
        return dataCache[yahooTicker];
      }

      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooTicker}?range=10y&interval=1mo&includePrePost=false`;

      try {
        const data = await fetchWithProxy(url);

        if (data.chart && data.chart.result && data.chart.result[0]) {
          const result = data.chart.result[0];
          const meta = result.meta;
          const quotes = result.indicators.quote[0];
          const timestamps = result.timestamp;

          // Build monthly price data with timestamps
          const monthlyData = [];
          for (let i = 0; i < timestamps.length; i++) {
            if (quotes.close[i] !== null) {
              monthlyData.push({
                date: new Date(timestamps[i] * 1000),
                price: quotes.close[i]
              });
            }
          }

          // Current price info
          const currentPrice = meta.regularMarketPrice;
          const previousClose = meta.previousClose || meta.chartPreviousClose;
          const priceChange = currentPrice - previousClose;
          const percentChange = (priceChange / previousClose) * 100;

          const tickerData = {
            ticker: yahooTicker,
            name: meta.shortName || meta.symbol,
            currentPrice,
            priceChange,
            percentChange,
            monthlyData,
            currency: meta.currency || 'USD'
          };

          // Cache the data
          dataCache[yahooTicker] = tickerData;
          return tickerData;
        }

        throw new Error('Invalid data format');
      } catch (error) {
        console.error('Error fetching stock data:', error);
        return getFallbackData(yahooTicker);
      }
    }

    // Fallback data if API fails
    function getFallbackData(ticker) {
      return {
        ticker,
        name: ticker,
        currentPrice: 0,
        priceChange: 0,
        percentChange: 0,
        monthlyData: [],
        isFallback: true
      };
    }

    // Backtest DCA strategy with actual historical prices
    function backtestDCA(monthlyData, monthlyAmount, yearsAgo) {
      const monthsAgo = yearsAgo * 12;
      const startIndex = Math.max(0, monthlyData.length - monthsAgo - 1);
      const relevantData = monthlyData.slice(startIndex);

      if (relevantData.length < 2) {
        return null;
      }

      let totalShares = 0;
      let totalInvested = 0;
      const portfolioValues = [];
      const investedValues = [];

      for (let i = 0; i < relevantData.length; i++) {
        const price = relevantData[i].price;

        // Buy shares each month
        const sharesBought = monthlyAmount / price;
        totalShares += sharesBought;
        totalInvested += monthlyAmount;

        // Record portfolio value at this point
        const portfolioValue = totalShares * price;
        portfolioValues.push({
          date: relevantData[i].date,
          value: portfolioValue,
          invested: totalInvested
        });
        investedValues.push(totalInvested);
      }

      const currentPrice = relevantData[relevantData.length - 1].price;
      const finalValue = totalShares * currentPrice;
      const profit = finalValue - totalInvested;
      const returnPercent = ((finalValue - totalInvested) / totalInvested) * 100;
      const avgCostPerShare = totalInvested / totalShares;

      // Max drawdown from peak portfolio value
      let peak = 0;
      let maxDrawdown = 0;
      for (const pv of portfolioValues) {
        if (pv.value > peak) peak = pv.value;
        const drawdown = (pv.value - peak) / peak;
        if (drawdown < maxDrawdown) maxDrawdown = drawdown;
      }

      return {
        totalInvested,
        finalValue,
        profit,
        returnPercent,
        totalShares,
        avgCostPerShare,
        maxDrawdown: maxDrawdown * 100,
        portfolioValues,
        investedValues
      };
    }

    // Backtest lump sum strategy with actual historical prices
    function backtestLumpSum(monthlyData, amount, yearsAgo) {
      const monthsAgo = yearsAgo * 12;
      const startIndex = Math.max(0, monthlyData.length - monthsAgo - 1);
      const relevantData = monthlyData.slice(startIndex);

      if (relevantData.length < 2) {
        return null;
      }

      const buyPrice = relevantData[0].price;
      const shares = amount / buyPrice;
      const portfolioValues = [];
      const investedValues = [];

      for (let i = 0; i < relevantData.length; i++) {
        const price = relevantData[i].price;
        portfolioValues.push({
          date: relevantData[i].date,
          value: shares * price,
          invested: amount
        });
        investedValues.push(amount);
      }

      const currentPrice = relevantData[relevantData.length - 1].price;
      const finalValue = shares * currentPrice;
      const profit = finalValue - amount;
      const returnPercent = ((finalValue - amount) / amount) * 100;

      // Max drawdown from peak portfolio value
      let peak = 0;
      let maxDrawdown = 0;
      for (const pv of portfolioValues) {
        if (pv.value > peak) peak = pv.value;
        const drawdown = (pv.value - peak) / peak;
        if (drawdown < maxDrawdown) maxDrawdown = drawdown;
      }

      return {
        totalInvested: amount,
        finalValue,
        profit,
        returnPercent,
        totalShares: shares,
        avgCostPerShare: buyPrice,
        maxDrawdown: maxDrawdown * 100,
        portfolioValues,
        investedValues
      };
    }

    // Calculate backtest results
    function calculate() {
      if (!state.tickerData || !state.tickerData.monthlyData || state.tickerData.monthlyData.length === 0) {
        return null;
      }

      if (state.style === 'dca') {
        return backtestDCA(state.tickerData.monthlyData, state.amount, state.years);
      } else {
        return backtestLumpSum(state.tickerData.monthlyData, state.amount, state.years);
      }
    }

    // Update stock info display
    function updateStockInfo() {
      if (!state.tickerData) return;

      const data = state.tickerData;

      if (data.isFallback) {
        stockPriceEl.textContent = 'No data';
        stockChangeEl.textContent = '(could not load)';
        stockChangeEl.className = 'stock-change';
      } else {
        stockPriceEl.textContent = `$${data.currentPrice.toFixed(2)}`;
        const sign = data.priceChange >= 0 ? '+' : '';
        stockChangeEl.textContent = `${sign}$${data.priceChange.toFixed(2)} (${sign}${data.percentChange.toFixed(2)}%)`;
        stockChangeEl.className = `stock-change ${data.priceChange >= 0 ? 'positive' : 'negative'}`;
      }
    }

    // Update results display
    function updateResults() {
      const results = calculate();
      if (!results) {
        document.getElementById('total-contributed').textContent = 'No data';
        document.getElementById('final-value').textContent = 'No data';
        document.getElementById('gain-loss').textContent = '';
        document.getElementById('max-drawdown').textContent = '-';
        document.getElementById('shares-owned').textContent = '-';
        document.getElementById('profit-text').innerHTML = '';
        document.getElementById('avg-cost-text').textContent = '';
        drawChart(null);
        return;
      }

      // Total contributed
      document.getElementById('total-contributed').textContent = formatCurrency(results.totalInvested);

      // Final value
      document.getElementById('final-value').textContent = formatCurrency(results.finalValue);

      // Profit text with return %
      const profitSign = results.profit >= 0 ? '+' : '';
      const gainLossEl = document.getElementById('gain-loss');
      gainLossEl.textContent = `(${formatPercent(results.returnPercent)})`;
      gainLossEl.className = results.returnPercent >= 0 ? 'positive' : 'negative';
      document.getElementById('profit-text').innerHTML = `Profit: ${profitSign}${formatCurrency(results.profit)} <span id="gain-loss" class="${results.returnPercent >= 0 ? 'positive' : 'negative'}">(${formatPercent(results.returnPercent)})</span>`;

      // Max drawdown
      const drawdownEl = document.getElementById('max-drawdown');
      drawdownEl.textContent = results.maxDrawdown.toFixed(1) + '%';
      drawdownEl.className = 'result-value negative';

      // Shares owned
      document.getElementById('shares-owned').textContent = results.totalShares.toFixed(4);
      document.getElementById('avg-cost-text').textContent = `Avg cost: $${results.avgCostPerShare.toFixed(2)}/share`;

      // Draw chart
      drawChart(results);
    }

    // Draw the chart
    function drawChart(results) {
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');

      // Set actual canvas size for crisp rendering
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const height = rect.height || 200;
      canvas.width = rect.width * dpr;
      canvas.height = height * dpr;
      ctx.scale(dpr, dpr);

      const width = rect.width;
      const padding = { top: 20, right: 20, bottom: 30, left: 60 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      if (!results || !results.portfolioValues || results.portfolioValues.length === 0) {
        ctx.fillStyle = '#9a8d79';
        ctx.font = '14px "Times New Roman", Times, serif';
        ctx.textAlign = 'center';
        ctx.fillText('No historical data available', width / 2, height / 2);
        return;
      }

      const values = results.portfolioValues;
      const allValues = values.map(v => v.value).concat(values.map(v => v.invested));
      const maxValue = Math.max(...allValues);
      const minValue = 0;

      // Scale functions
      const scaleX = (i) => padding.left + (i / (values.length - 1)) * chartWidth;
      const scaleY = (v) => padding.top + chartHeight - ((v - minValue) / (maxValue - minValue)) * chartHeight;

      // Draw grid lines
      ctx.strokeStyle = '#e5e0d5';
      ctx.lineWidth = 1;

      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (i / 4) * chartHeight;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
      }

      // Draw Y-axis labels
      ctx.fillStyle = '#9a8d79';
      ctx.font = '11px "Times New Roman", Times, serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';

      for (let i = 0; i <= 4; i++) {
        const value = minValue + ((4 - i) / 4) * (maxValue - minValue);
        const y = padding.top + (i / 4) * chartHeight;
        ctx.fillText(formatCurrency(value), padding.left - 8, y);
      }

      // Draw X-axis labels (dates)
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';

      const labelCount = Math.min(5, values.length);
      for (let i = 0; i < labelCount; i++) {
        const idx = Math.floor((i / (labelCount - 1)) * (values.length - 1));
        const x = scaleX(idx);
        const date = values[idx].date;
        const label = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        ctx.fillText(label, x, height - padding.bottom + 8);
      }

      // Draw invested line (dashed)
      ctx.strokeStyle = '#d4cfc4';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.beginPath();

      values.forEach((v, i) => {
        const x = scaleX(i);
        const y = scaleY(v.invested);
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.stroke();
      ctx.setLineDash([]);

      // Draw portfolio value line
      ctx.strokeStyle = '#a08c6d';
      ctx.lineWidth = 2.5;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();

      values.forEach((v, i) => {
        const x = scaleX(i);
        const y = scaleY(v.value);
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.stroke();

      // Fill area between lines
      ctx.beginPath();
      values.forEach((v, i) => {
        const x = scaleX(i);
        const y = scaleY(v.value);
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      for (let i = values.length - 1; i >= 0; i--) {
        const x = scaleX(i);
        const y = scaleY(values[i].invested);
        ctx.lineTo(x, y);
      }
      ctx.closePath();

      const isProfit = results.returnPercent >= 0;
      ctx.fillStyle = isProfit ? 'rgba(90, 122, 90, 0.15)' : 'rgba(139, 90, 90, 0.15)';
      ctx.fill();
    }

    // Load ticker data and update UI
    async function loadTicker(symbol, yahooTicker) {
      resultsCard.classList.add('loading');
      stockPriceEl.textContent = 'Loading...';
      stockChangeEl.textContent = '';

      state.ticker = symbol;
      state.yahooTicker = yahooTicker;
      state.tickerData = await fetchStockData(yahooTicker);

      updateStockInfo();
      updateResults();
      resultsCard.classList.remove('loading');
    }

    // --- Ticker search dropdown ---
    function renderDropdown(filter) {
      const query = filter.toLowerCase();
      const matches = TICKERS.filter(t =>
        t.symbol.toLowerCase().includes(query) ||
        t.name.toLowerCase().includes(query)
      );

      tickerDropdown.innerHTML = '';
      matches.forEach(t => {
        const div = document.createElement('div');
        div.className = 'ticker-option';
        div.innerHTML = `<span class="ticker-symbol">${t.symbol}</span><span class="ticker-name">${t.name}</span>`;
        div.addEventListener('mousedown', (e) => {
          e.preventDefault();
          selectTicker(t);
        });
        tickerDropdown.appendChild(div);
      });

      if (matches.length > 0) {
        tickerDropdown.classList.add('open');
        tickerSearch.classList.add('has-focus');
      } else {
        tickerDropdown.classList.remove('open');
        tickerSearch.classList.remove('has-focus');
      }
    }

    function selectTicker(t) {
      state.ticker = t.symbol;
      tickerSearch.value = `${t.symbol} - ${t.name}`;
      tickerDropdown.classList.remove('open');
      tickerSearch.classList.remove('has-focus');
      tickerSearch.blur();
      loadTicker(t.symbol, t.yahoo);
    }

    tickerSearch.addEventListener('focus', () => {
      tickerSearch.value = '';
      renderDropdown('');
    });

    tickerSearch.addEventListener('input', () => {
      renderDropdown(tickerSearch.value);
    });

    tickerSearch.addEventListener('blur', () => {
      tickerDropdown.classList.remove('open');
      tickerSearch.classList.remove('has-focus');
      // Restore display value
      const current = TICKERS.find(t => t.symbol === state.ticker);
      if (current) {
        tickerSearch.value = `${current.symbol} - ${current.name}`;
      }
    });

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.ticker-search-wrapper')) {
        tickerDropdown.classList.remove('open');
        tickerSearch.classList.remove('has-focus');
      }
    });

    // --- Other event listeners ---
    styleBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        styleBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.style = btn.dataset.style;

        if (state.style === 'dca') {
          amountLabel.textContent = 'Monthly Amount';
          amountHint.textContent = "Amount you'd invest each month";
          amountInput.value = '500';
          state.amount = 500;
        } else {
          amountLabel.textContent = 'Initial Investment';
          amountHint.textContent = 'One-time investment amount';
          amountInput.value = '10000';
          state.amount = 10000;
        }

        updateResults();
      });
    });

    amountInput.addEventListener('input', (e) => {
      const value = e.target.value.replace(/[^0-9]/g, '');
      state.amount = parseInt(value) || 0;
      updateResults();
    });

    amountInput.addEventListener('blur', (e) => {
      if (state.amount > 0) {
        e.target.value = state.amount.toLocaleString();
      }
    });

    amountInput.addEventListener('focus', (e) => {
      e.target.value = state.amount || '';
    });

    yearsSlider.addEventListener('input', (e) => {
      state.years = parseInt(e.target.value);
      yearsDisplay.textContent = state.years;
      updateResults();
    });

    // Handle window resize for chart
    window.addEventListener('resize', updateResults);

    // Initial load
    const defaultTicker = TICKERS.find(t => t.symbol === 'VOO');
    tickerSearch.value = `${defaultTicker.symbol} - ${defaultTicker.name}`;
    loadTicker(defaultTicker.symbol, defaultTicker.yahoo);
  </script>
</body>
</html>
